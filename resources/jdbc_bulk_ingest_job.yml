resources:
  jobs:
    partitioned_query_ingest:
      name: JDBC Bulk Ingest
      tasks:
        - task_key: get_query_list
          existing_cluster_id: 0729-212854-o3mbohsl
          webhook_notifications: {}
          email_notifications: {}
          run_if: ALL_SUCCESS
          notification_settings: {}
          notebook_task:
            notebook_path: ../src/get_query_list.ipynb
            base_parameters:
              catalog: "{{job.parameters.catalog}}"
              schema: "{{job.parameters.schema}}"
              src_table: "{{job.parameters.src_table}}"
              tgt_table: "{{job.parameters.tgt_table}}"
            source: WORKSPACE
        - task_key: lang_select
          depends_on:
            - task_key: get_query_list
          notification_settings: {}
          email_notifications: {}
          condition_task:
            op: EQUAL_TO
            right: sql
            left: '{{job.parameters.lang}}'
          webhook_notifications: {}
          run_if: ALL_SUCCESS
        - task_key: run_queries_sql
          depends_on:
            - outcome: "true"
              task_key: lang_select
          notification_settings: {}
          webhook_notifications: {}
          for_each_task:
            concurrency: 8
            inputs: '{{tasks.get_query_list.values.partition_queries}}'
            task:
              notification_settings: {}
              run_if: ALL_SUCCESS
              task_key: run_query_sql
              notebook_task:
                base_parameters:
                  qry: '{{input.full_query}}'
                notebook_path: ../src/run_query_sql.sql
                source: WORKSPACE
              webhook_notifications: {}
              email_notifications: {}
              max_retries: 3
              min_retry_interval_millis: 0
          email_notifications: {}
          run_if: ALL_SUCCESS
        - task_key: run_queries_py
          depends_on:
            - outcome: "false"
              task_key: lang_select
          email_notifications: {}
          notification_settings: {}
          run_if: ALL_SUCCESS
          for_each_task:
            concurrency: 8
            inputs: '{{tasks.get_query_list.values.partition_queries}}'
            task:
              notification_settings: {}
              email_notifications: {}
              notebook_task:
                base_parameters:
                  src_query: '{{input.srcQuery}}'
                notebook_path: ../src/run_query_py.ipynb
                source: WORKSPACE
              task_key: run_query_py
              existing_cluster_id: 0729-212854-o3mbohsl
              run_if: ALL_SUCCESS
              webhook_notifications: {}
              max_retries: 3
              min_retry_interval_millis: 0
          webhook_notifications: {}
      max_concurrent_runs: 1
      parameters:
        - default: sql
          name: lang
        - default: main
          name: catalog
        - default: chris_koester
          name: schema
        - default: partitioned_queries_src
          name: src_table
        - default: partitioned_queries_tgt
          name: tgt_table
      webhook_notifications: {}
      email_notifications: {}
      queue:
        enabled: true
