resources:
  jobs:
    partitioned_query_ingest:
      name: JDBC Bulk Ingest
      tasks:
        - task_key: get_query_list
          existing_cluster_id: ${var.existing_cluster_id}
          run_if: ALL_SUCCESS
          notebook_task:
            notebook_path: ../src/get_query_list.ipynb
            source: WORKSPACE
        - task_key: create_tgt_table
          existing_cluster_id: ${var.existing_cluster_id}
          depends_on:
            - task_key: get_query_list
          notebook_task:
            notebook_path: ../src/create_tgt_table.ipynb
            base_parameters:
              catalog: "{{job.parameters.tgt_catalog}}"
              schema: "{{job.parameters.tgt_schema}}"
              tgt_table: "{{job.parameters.tgt_table}}"
            source: WORKSPACE
        - task_key: if_sql
          depends_on:
            - task_key: create_tgt_table
          notification_settings: {}
          email_notifications: {}
          condition_task:
            op: EQUAL_TO
            right: sql
            left: '{{job.parameters.lang}}'
          run_if: ALL_SUCCESS
        - task_key: run_queries_sql
          depends_on:
            - outcome: "true"
              task_key: if_sql
          for_each_task:
            concurrency: 8
            inputs: '{{tasks.get_query_list.values.partition_queries}}'
            task:
              run_if: ALL_SUCCESS
              task_key: run_query_sql
              notebook_task:
                base_parameters:
                  qry: '{{input.full_query}}'
                notebook_path: ../src/run_query_sql.sql
                source: WORKSPACE
                warehouse_id: d1184b8c2a8a87eb
              max_retries: 3
              min_retry_interval_millis: 0
          run_if: ALL_SUCCESS
        - task_key: run_queries_py
          depends_on:
            - outcome: "false"
              task_key: if_sql
          run_if: ALL_SUCCESS
          for_each_task:
            concurrency: 8
            inputs: '{{tasks.get_query_list.values.partition_queries}}'
            task:
              task_key: run_query_py
              notebook_task:
                base_parameters:
                  qry: '{{input.full_query}}'
                notebook_path: ../src/run_query_py.ipynb
                source: WORKSPACE
              existing_cluster_id: ${var.existing_cluster_id}
              run_if: ALL_SUCCESS
              max_retries: 3
              min_retry_interval_millis: 0
      max_concurrent_runs: 1
      parameters:
        - default: python
          name: lang
        - default: ckoester_sql_server
          name: src_catalog
        - default: dbo
          name: src_schema
        - default: partitioned_queries_src
          name: src_table
        - default: main
          name: tgt_catalog
        - default: chris_koester
          name: tgt_schema
        - default: partitioned_queries_tgt
          name: tgt_table
        - default: customer_id
          name: partition_col
      queue:
        enabled: false
